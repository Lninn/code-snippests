


{% extends '__base__.html' %}

{% block title %} 日志 {% endblock %}

{% block beforehead %}
<script>

window.onload = function() {
    const vm = new Vue({
        el: '#vm',
        data () {
            return {
                blogs: [],
                page: {
                    page_size: 0,
                    page_total: 0
                },
                currentPage: 1
            }
        },
        beforeCreate() {
            const that = this
            const index = '1'
            axios.get('/api/blogs', {
                page: index
            })
            .then(function (data) {
                data = data.data

                if (data.error) {
                    return alert('error status: ' + data.error + 'message: ' + data.message)
                } else {
                    that.blogs = data.blogs
                    that.page = data.page
                }
            })
            .catch(function (error) {
            })
        },
        methods: {
            handleSizeChange(val) {

            },
            handleCurrentChange(val) {
                const that = this
                axios.get('/api/blogs?page=' + val)
                .then(function (data) {
                    data = data.data

                    if (data.error) {
                        return alert('error status: ' + data.error + 'message: ' + data.message)
                    } else {
                        that.blogs = data.blogs
                        that.page = data.page
                    }
                })
                .catch(function (error) {
                    log('Error: ', error)
                })
            },
            delete_blog(blog) {
                if(confirm("是否确认删除?")){
                    axios.post('/api/blogs/' + blog.id + '/delete', {
                        'Content-Type': 'application/json'
                    })
                    .then(function (data) {
                        data = data.data

                        if (data.error) {
                            return alert('error status: ' + data.error + 'message: ' + data.message)
                        } else {
                            location.reload()
                        }
                    })
                    .catch(function (error) {
                        console.log('Error: ', error)
                    })
                }
            }
        },
        filters: {
          capitalize: function (value) {
            var now = new Date()
            delta = now.getTime() / 1000 - value

            if (delta < 60) {
                return '1分钟前'
            }
            if (delta < 3600) {
                return Math.floor((delta / 60)) + '分钟前'
            }
            if (delta < 86400) {
                return Math.floor((delta / 3600)) + '小时前'
            }
            if (delta < 604800) {
                return Math.floor((delta / 86400)) + '小时前'
            }

            var dt = new Date(value * 1000)

            return dt.getFullYear() + '年' + dt.getMonth() + '月' + dt.getDate() + '日'
          }
        }
    })
}

</script>
{% endblock %}

{% block content %}
<div class="uk-width-1-1 uk-margin-bottom">
    <div class="uk-panel uk-panel-box">
        <ul class="uk-breadcrumb">
            <li><a href="/manage/comments">评论</a></li>
            <li class="uk-active"><span>日志</span></li>
            <li><a href="/manage/users">用户</a></li>
        </ul>
    </div>
</div>

<div id="vm" class="uk-width-1-1">
    <a href="/manage/blogs/create" class="uk-button uk-button-primary"><i class="uk-icon-plus"></i> 新日志</a>

    <table class="uk-table uk-table-hover">
        <thead>
            <tr>
                <th class="">标题 / 摘要</th>
                <th class="">作者</th>
                <th class="">创建时间</th>
                <th class="">操作</th>
            </tr>
        </thead>
        <tbody>
            <tr v-for="blog in blogs">
                <td>
                    <a target="_blank" :href="'/blog/' + blog.id" v-text="blog.name"></a>
                </td>
                <td>
                    <a target="_blank" :href="'/user/'+blog.user_id" v-text="blog.user_name"></a>
                </td>
                <td>
                    <span v-text="new Date(blog.created_at * 1000).toLocaleString()"></span>
                </td>
                <td>
                    <a :href="'/manage/blogs/edit?id=' + blog.id">编辑</a>
                    <a @click="delete_blog(blog)">删除</a>
                </td>
            </tr>
        </tbody>
    </table>

    <div class="block">
      <el-pagination
        @size-change="handleSizeChange"
        @current-change="handleCurrentChange"
        :current-page="currentPage"
        :page-sizes="[7, 10, 15]"
        :page-size="page.page_size"
        layout="total, sizes, prev, pager, next, jumper"
        :total="page.page_total">
      </el-pagination>
    </div>
</div>
{% endblock %}
